<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>docker-staticmaps demo</title>
    <link rel="stylesheet" href="ol.css" />
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        padding: 1.5rem;
        background: #f8fafc;
        color: #1e293b;
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        gap: 1rem;
      }

      h1 {
        margin: 0;
        font-size: 1.5rem;
      }

      #map {
        width: 100%;
        height: 400px;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      .controls {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      button {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 0.5rem;
        background: #3b82f6;
        color: #fff;
        font-size: 0.95rem;
        cursor: pointer;
        transition: background 0.2s;
      }

      button:hover {
        background: #2563eb;
      }

      p {
        margin: 0;
        font-size: 0.9rem;
      }

      #staticMapUrlDisplay {
        font-family: monospace;
        color: #0f172a;
      }

      img.static-map {
        margin-top: 1rem;
        width: 100%;
        max-height: 400px;
        border-radius: 0.75rem;
        object-fit: cover;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }
    </style>
  </head>
  <body>
    <h1>github.com/docker-staticmaps demo</h1>
    <div id="map"></div>

    <button class="button" id="toggleBasemap">Switch to OSMTopo</button>
    <button class="button" id="generateStaticMap">Generate Static Map</button>

    <p>
      <strong>Current Static Map URL:</strong>
      <span id="staticMapUrlDisplay" style="word-break: break-all"
        >/staticmaps?</span
      >
    </p>

    <script src="ol.js"></script>
    <script>
      let map
      let currentBasemap = "osm" // Default base map
      const center = [0, 20] // Starting center
      const zoom = 1 // Starting zoom
      const height = 400
      let isLoading = false
      let staticMapImgElement = null

      // Initialize the map
      function initializeMap() {
        const osmLayer = new ol.layer.Tile({
          source: new ol.source.OSM(),
        })

        const layerGroup = new ol.layer.Group({
          layers: [osmLayer],
        })

        map = new ol.Map({
          target: "map",
          layers: [layerGroup],
          view: new ol.View({
            center: ol.proj.fromLonLat(center),
            zoom: zoom,
            projection: "EPSG:3857",
          }),
        })

        // Update static map URL on every moveend event
        map.on("moveend", function () {
          const view = map.getView()
          const centerLonLat = ol.proj.toLonLat(view.getCenter())
          updateStaticMapUrl(centerLonLat, view.getZoom(), currentBasemap)
        })

        // Update map size on window resize
        window.addEventListener("resize", () => {
          map.updateSize()
        })
      }

      // Update static map URL dynamically
      function updateStaticMapUrl(centerLonLat, zoom, currentBasemap) {
        const mapWidth = document.getElementById("map").offsetWidth
        const lat = centerLonLat[1]
        const lon = centerLonLat[0]
        const staticMapUrl = `/staticmaps?width=${mapWidth}&height=${height}&center=${encodeURIComponent(lat + "," + lon)}&zoom=${Math.round(zoom)}&basemap=${currentBasemap}`

        document.getElementById("staticMapUrlDisplay").textContent =
          staticMapUrl
      }

      // Switch between basemaps (OSM and OSMTopo)
      function toggleBasemap() {
        const osmtopoLayer = new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: "https://tile.opentopomap.org/{z}/{x}/{y}.png",
          }),
        })

        const osmLayer = new ol.layer.Tile({
          source: new ol.source.OSM(),
        })

        const layerGroup = map.getLayers().item(0)
        layerGroup.getLayers().clear()

        if (currentBasemap === "osm") {
          layerGroup.getLayers().push(osmtopoLayer)
          currentBasemap = "otm"
          document.getElementById("toggleBasemap").innerText = "Switch to OSM"
        } else {
          layerGroup.getLayers().push(osmLayer)
          currentBasemap = "osm"
          document.getElementById("toggleBasemap").innerText =
            "Switch to OSMTopo"
        }
      }

      // Generate a static map image
      function generateStaticMap() {
        if (isLoading) return
        isLoading = true

        const mapWidth = document.getElementById("map").offsetWidth
        const view = map.getView()
        const centerLonLat = ol.proj.toLonLat(view.getCenter())
        const lat = centerLonLat[1]
        const lon = centerLonLat[0]
        const currentZoom = Math.round(view.getZoom())
        const staticMapUrl = `/demo-map?width=${mapWidth}&height=${height}&center=${encodeURIComponent(lat + "," + lon)}&zoom=${currentZoom}&basemap=${currentBasemap}`

        // Update the URL display
        document.getElementById("staticMapUrlDisplay").textContent =
          staticMapUrl

        fetch(staticMapUrl)
          .then((response) => response.blob())
          .then((blob) => {
            const imgURL = URL.createObjectURL(blob)
            if (staticMapImgElement) {
              staticMapImgElement.src = imgURL
            } else {
              staticMapImgElement = document.createElement("img")
              staticMapImgElement.src = imgURL
              staticMapImgElement.style.width = "100%"
              staticMapImgElement.style.height = `${height}px`
              document.body.appendChild(staticMapImgElement)
            }
          })
          .catch((error) =>
            console.error("Error generating static map:", error)
          )
          .finally(() => {
            isLoading = false
          })
      }

      // Event listeners for buttons
      document
        .getElementById("toggleBasemap")
        .addEventListener("click", toggleBasemap)
      document
        .getElementById("generateStaticMap")
        .addEventListener("click", generateStaticMap)

      // Initialize the map when the page loads
      window.onload = initializeMap
    </script>
  </body>
</html>
